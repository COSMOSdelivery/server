generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CLIENT
  ADMIN
  LIVREUR
  SERVICECLIENT
}

enum ModePaiement {
  ESPECE
  CHEQUE
  ESPECE_ou_CHEQUE
}

enum EtatCommande {
  EN_ATTENTE
  A_ENLEVER
  ENLEVE
  AU_DEPOT
  RETOUR_DEPOT
  EN_COURS
  A_VERIFIER
  LIVRES
  LIVRES_PAYE
  ECHANGE
  RETOUR_DEFINITIF
  RETOUR_INTER_AGENCE
  RETOUR_EXPEDITEURS
  RETOUR_RECU_PAYE
}

enum EtatFeedback {
  EN_COURS
  RESOLU
  EN_ATTENTE
}

model Utilisateur {
  id                Int            @id @default(autoincrement())
  nom               String
  prenom            String
  email             String         @unique
  password          String
  telephone1        String
  telephone2        String?
  codeTVA           String
  cin               String         @unique
  role              Role
  dateInscription   DateTime       @default(now())
  derniereMiseAJour DateTime       @updatedAt
  admin             Admin?
  client            Client?
  livreur           Livreur?
  serviceclient     Serviceclient?
  resetPasswordOtp     String?  // Add this line for the OTP field
  resetPasswordOtpExpiry DateTime?
  imageUrl String?  
}

model Admin {
  idAdmin     Int         @id @default(autoincrement())
  utilisateur Utilisateur @relation(fields: [idAdmin], references: [id], onDelete: Cascade)
}

model Serviceclient {
  idServiceclient Int         @id @default(autoincrement())
  utilisateur     Utilisateur @relation(fields: [idServiceclient], references: [id], onDelete: Cascade)
}

model Client {
  idClient         Int                @id @default(autoincrement())
  utilisateur      Utilisateur        @relation(fields: [idClient], references: [id], onDelete: Cascade)
  nomShop          String
  gouvernorat      String
  ville            String
  localite         String
  codePostal       String
  adresse          String
  fraisLivraison   Float              @default(7) // default well be deleted
  fraisRetour      Float              @default(7) // default well be deleted
  Commandes        Commande[] // Relation avec plusieurs commandes
  FeedbackCommande FeedbackCommande[]
  Manifeste        Manifeste[]
  //Paiement         Paiement[]
}

model Livreur {
  idLivreur   Int                  @id @default(autoincrement())
  utilisateur Utilisateur          @relation(fields: [idLivreur], references: [id], onDelete: Cascade)
  gouvernorat String
  Historique  HistoriqueCommande[] // Relation avec l'historique des commandes
  commandes   Commande[] // Relation with Commande
}

model Commande {
  code_a_barre         Int                  @id @default(autoincrement())
  nom_prioritaire      String
  prenom_prioritaire   String
  gouvernorat          String
  ville                String
  localite             String
  codePostal           String
  adresse              String
  telephone1           String
  telephone2           String?
  designation          String
  prix                 Float
  nb_article           Int
  etat                 EtatCommande
  mode_paiement        ModePaiement
  possible_ouvrir      Boolean
  possible_echange     Boolean
  code_a_barre_echange Int? // seulement dans le cas d'echange
  nb_article_echange   Int? // seulement dans le cas d'echange
  remarque             String?
  est_imprimer         Boolean              @default(false)
  id_livreur           Int?
  dateAjout            DateTime             @default(now())
  derniereMiseAJour    DateTime             @updatedAt
  id_client            Int
  client               Client               @relation(fields: [id_client], references: [idClient])
    livreur              Livreur?             @relation(fields: [id_livreur], references: [idLivreur]) // Add this line
  Historique           HistoriqueCommande[] // Relation avec l'historique des commandes
  feedbacks            FeedbackCommande[] // Relation avec les feedbacks de la commande
  manifesteId          Int?
  Manifeste            Manifeste?           @relation(fields: [manifesteId], references: [id])
  //Paiement             Paiement[]
}

model HistoriqueCommande {
  id          Int          @id @default(autoincrement())
  date        DateTime     @default(now())
  etat        EtatCommande // État à ce moment de l'historique
  commentaire String?
  id_commande Int
  id_livreur  Int?
  commande    Commande     @relation(fields: [id_commande], references: [code_a_barre], onDelete: Cascade)
  livreur     Livreur?     @relation(fields: [id_livreur], references: [idLivreur], onDelete: Cascade)

  @@unique([id_commande, id_livreur, date]) // Permet de tracer les changements d'état avec timestamp
}

model FeedbackCommande {
  id          Int      @id @default(autoincrement())
  titre       String
  commentaire String
  dateAjout   DateTime @default(now())
  //etatFeedback EtatFeedback @default(EN_ATTENTE)          maybe ++
  id_commande Int
  commande    Commande @relation(fields: [id_commande], references: [code_a_barre])
  id_client   Int
  client      Client   @relation(fields: [id_client], references: [idClient])
}

model Manifeste {
  id           Int        @id @default(autoincrement())
  dateCreation DateTime   @default(now())
  id_client    Int
  client       Client     @relation(fields: [id_client], references: [idClient])
  commandes    Commande[]
  estImprime   Boolean    @default(false)
}

//model Paiement {
//  id           Int       @id @default(autoincrement())
//  datePaiement DateTime  @default(now())
//  montant      Float
//  id_client    Int
//  client       Client    @relation(fields: [id_client], references: [idClient])
//  id_commande  Int?
//  commande     Commande? @relation(fields: [id_commande], references: [code_a_barre])
//}
